import React, { useState } from 'react';
import { ArrowDown, ArrowUp, Database, Settings, CheckCircle, FileText, TrendingUp, AlertCircle, RefreshCw, Sparkles, MessageSquare, Lightbulb, X } from 'lucide-react';

const DataValueChainCanvas = () => {
  const [activeFlow, setActiveFlow] = useState('both'); // 'down', 'up', 'both'
  const [showAiModal, setShowAiModal] = useState(false);
  const [aiMode, setAiMode] = useState(null); // 'scenario' or 'consult'
  const [aiResponse, setAiResponse] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [userQuery, setUserQuery] = useState('');
  const [error, setError] = useState('');

  // Gemini Configuration
  const apiKey = ""; // API Key injected by environment

  const callGemini = async (prompt) => {
    setIsLoading(true);
    setAiResponse('');
    setError('');
    
    try {
      // Retry logic for robustness
      let attempts = 0;
      let success = false;
      let resultText = "";

      while (attempts < 3 && !success) {
        try {
          const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }] }],
              }),
            }
          );

          if (!response.ok) throw new Error('API request failed');

          const data = await response.json();
          resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
          if (resultText) success = true;
        } catch (e) {
          attempts++;
          await new Promise(r => setTimeout(r, 1000 * attempts)); // Exponential backoff
        }
      }

      if (success) {
        setAiResponse(resultText);
      } else {
        setError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AI ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      }
    } catch (err) {
      setError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î: ' + err.message);
    } finally {
      setIsLoading(false);
    }
  };

  const generateScenario = () => {
    setAiMode('scenario');
    setShowAiModal(true);
    const prompt = `
      Create a realistic Data Analytics Use Case for a large organization (e.g., Energy Utility, Bank, or Retail).
      Title the use case clearly.
      Then, break down this specific use case into the 5 levels of the Data Value Chain hierarchy:
      
      5. Strategy & AI: What is the business goal or AI solution?
      4. Requirement: What specific data/KPIs are needed?
      3. Readiness: What data quality or governance issues might arise?
      2. Engineering: How is data collected/processed (Pipeline)?
      1. Source: Where does the raw data come from?

      Please answer in Thai language. Make it concise and easy to read.
      Format with clear headers or bullet points.
    `;
    callGemini(prompt);
  };

  const consultAI = () => {
    if (!userQuery.trim()) return;
    const prompt = `
      Act as a Senior Data Strategy Consultant. 
      The user is asking about this problem: "${userQuery}".
      
      Analyze this problem using the "Data Value Chain" framework (Levels 1-5).
      1. Diagnose: Which level (1-5) is likely the bottleneck?
      2. Strategy: Should they focus on "Demand Driven" (Top-down) or "Supply Driven" (Bottom-up) right now?
      3. Action: Give 3 specific actionable steps.

      Please answer in Thai language. Tone: Professional, encouraging, and strategic (like a senior director).
    `;
    callGemini(prompt);
  };

  const steps = [
    {
      level: 5,
      title: "5. ‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå & AI (Strategy)",
      desc: "AI Roadmap / Business Solutions",
      icon: <TrendingUp className="w-6 h-6" />,
      color: "bg-purple-600"
    },
    {
      level: 4,
      title: "4. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (Requirement)",
      desc: "Business Questions / KPIs",
      icon: <FileText className="w-6 h-6" />,
      color: "bg-blue-600"
    },
    {
      level: 3,
      title: "3. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Readiness)",
      desc: "Quality / Governance / Catalog",
      icon: <CheckCircle className="w-6 h-6" />,
      color: "bg-indigo-500"
    },
    {
      level: 2,
      title: "2. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° (Engineering)",
      desc: "Pipeline / ETL / Platform",
      icon: <Settings className="w-6 h-6" />,
      color: "bg-cyan-600"
    },
    {
      level: 1,
      title: "1. ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Source)",
      desc: "Raw Data / ERP / IoT",
      icon: <Database className="w-6 h-6" />,
      color: "bg-slate-600"
    }
  ];

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800 relative">
      <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200">
        
        {/* Header */}
        <div className="bg-slate-900 p-6 text-white text-center relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 via-blue-500 to-cyan-500"></div>
          <h1 className="text-2xl md:text-3xl font-bold mb-2 flex items-center justify-center gap-3">
            <RefreshCw className="w-8 h-8 text-cyan-400" />
            ‡∏ß‡∏á‡∏à‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á Data Strategy
          </h1>
          <p className="text-slate-300 text-sm md:text-base">
            Data Value Chain: Balancing Demand (Strategy) & Supply (Source)
          </p>
        </div>

        {/* AI Action Bar */}
        <div className="bg-purple-50 p-4 border-b border-purple-100 flex flex-col md:flex-row gap-4 items-center justify-between">
          <div className="flex items-center gap-2 text-purple-800 font-semibold">
            <Sparkles className="w-5 h-5 text-purple-600 animate-pulse" />
            <span>AI Powered Features:</span>
          </div>
          <div className="flex gap-3 w-full md:w-auto">
             <button 
              onClick={generateScenario}
              className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-white text-purple-700 border border-purple-200 hover:bg-purple-100 px-4 py-2 rounded-lg text-sm font-medium transition-colors shadow-sm"
            >
              <Lightbulb className="w-4 h-4" />
              ‚ú® ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Use Case
            </button>
            <button 
              onClick={() => { setAiMode('consult'); setShowAiModal(true); setAiResponse(''); }}
              className="flex-1 md:flex-none flex items-center justify-center gap-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:from-purple-700 hover:to-indigo-700 px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-md"
            >
              <MessageSquare className="w-4 h-4" />
              ‚ú® ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Data
            </button>
          </div>
        </div>

        {/* Controls */}
        <div className="flex justify-center gap-2 md:gap-4 py-6 bg-slate-50 border-b border-slate-100 flex-wrap px-4">
          <button 
            onClick={() => setActiveFlow('down')}
            className={`px-4 py-2 rounded-full text-xs md:text-sm font-semibold transition-all flex items-center gap-2 ${activeFlow === 'down' ? 'bg-purple-600 text-white shadow-lg scale-105' : 'bg-white text-slate-600 border border-slate-300 hover:bg-purple-50'}`}
          >
            <ArrowDown className="w-4 h-4" /> Demand (‡∏Ç‡∏≤‡∏•‡∏á)
          </button>
          <button 
            onClick={() => setActiveFlow('up')}
            className={`px-4 py-2 rounded-full text-xs md:text-sm font-semibold transition-all flex items-center gap-2 ${activeFlow === 'up' ? 'bg-cyan-600 text-white shadow-lg scale-105' : 'bg-white text-slate-600 border border-slate-300 hover:bg-cyan-50'}`}
          >
            <ArrowUp className="w-4 h-4" /> Supply (‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô)
          </button>
          <button 
            onClick={() => setActiveFlow('both')}
            className={`px-4 py-2 rounded-full text-xs md:text-sm font-semibold transition-all flex items-center gap-2 ${activeFlow === 'both' ? 'bg-slate-800 text-white shadow-lg scale-105' : 'bg-white text-slate-600 border border-slate-300 hover:bg-slate-100'}`}
          >
            <RefreshCw className="w-4 h-4" /> ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Loop)
          </button>
        </div>

        {/* Main Diagram Area */}
        <div className="p-6 md:p-10 flex flex-col md:flex-row gap-8 relative min-h-[600px] justify-center items-center">
          
          {/* Left Flow: Demand Driven */}
          <div className={`flex flex-col items-center w-full md:w-1/4 transition-opacity duration-500 ${activeFlow === 'up' ? 'opacity-20 blur-[1px]' : 'opacity-100'}`}>
            <div className="bg-purple-100 text-purple-800 p-4 rounded-lg mb-4 text-center border border-purple-200 shadow-sm w-full">
              <h3 className="font-bold text-lg mb-1">Demand Driven</h3>
              <p className="text-xs">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà "‡πÇ‡∏à‡∏ó‡∏¢‡πå" (Why)</p>
            </div>
            <div className="h-[450px] w-4 bg-gradient-to-b from-purple-500 to-slate-300 rounded-full relative">
              <div className="absolute -bottom-2 left-1/2 transform -translate-x-1/2">
                <ArrowDown className="w-8 h-8 text-slate-500" />
              </div>
              
              <div className="absolute top-[10%] left-6 w-40 md:w-48 text-xs text-purple-700 font-medium bg-white/80 p-2 rounded backdrop-blur-sm border border-purple-100 shadow-sm hidden md:block">
                1. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (Goal Setting)
              </div>
              <div className="absolute top-[50%] left-6 w-40 md:w-48 text-xs text-purple-700 font-medium bg-white/80 p-2 rounded backdrop-blur-sm border border-purple-100 shadow-sm hidden md:block">
                2. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏£‡∏∞‡∏ö‡∏ö (Design)
              </div>
              <div className="absolute bottom-[10%] left-6 w-40 md:w-48 text-xs text-purple-700 font-medium bg-white/80 p-2 rounded backdrop-blur-sm border border-purple-100 shadow-sm hidden md:block">
                3. ‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Sourcing)
              </div>
            </div>
             <p className="mt-4 text-center text-sm font-bold text-purple-700">"‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏≠‡∏∞‡πÑ‡∏£?"</p>
          </div>

          {/* Central Pyramid */}
          <div className="flex flex-col gap-3 w-full md:w-2/4 z-10">
            {steps.map((step) => (
              <div 
                key={step.level}
                className={`relative flex items-center p-4 rounded-xl shadow-md border-l-8 transition-all duration-300 transform hover:scale-105 hover:shadow-lg cursor-pointer group bg-white border-slate-200`}
                style={{ borderLeftColor: step.color.replace('bg-', '') }}
              >
                <div className={`p-3 rounded-full mr-4 text-white ${step.color} shadow-sm group-hover:rotate-12 transition-transform`}>
                  {step.icon}
                </div>
                <div className="flex-1">
                  <div className="flex justify-between items-center mb-1">
                    <h3 className="font-bold text-slate-800 text-lg">{step.title}</h3>
                    <span className="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">Lv.{step.level}</span>
                  </div>
                  <p className="text-slate-500 text-sm">{step.desc}</p>
                </div>
                
                {step.level > 1 && (
                  <div className="absolute -bottom-4 left-1/2 w-0.5 h-4 bg-slate-200 -z-10"></div>
                )}
              </div>
            ))}
          </div>

          {/* Right Flow: Supply Driven */}
          <div className={`flex flex-col items-center w-full md:w-1/4 transition-opacity duration-500 ${activeFlow === 'down' ? 'opacity-20 blur-[1px]' : 'opacity-100'}`}>
             <div className="bg-cyan-100 text-cyan-800 p-4 rounded-lg mb-4 text-center border border-cyan-200 shadow-sm w-full">
              <h3 className="font-bold text-lg mb-1">Supply Driven</h3>
              <p className="text-xs">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà "‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ" (What)</p>
            </div>
            <div className="h-[450px] w-4 bg-gradient-to-t from-cyan-500 to-purple-300 rounded-full relative">
              <div className="absolute -top-2 left-1/2 transform -translate-x-1/2">
                <ArrowUp className="w-8 h-8 text-purple-400" />
              </div>

               <div className="absolute bottom-[10%] right-6 w-40 md:w-48 text-xs text-cyan-700 font-medium bg-white/80 p-2 rounded backdrop-blur-sm border border-cyan-100 text-right shadow-sm hidden md:block">
                1. ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Data Collection)
              </div>
              <div className="absolute top-[50%] right-6 w-40 md:w-48 text-xs text-cyan-700 font-medium bg-white/80 p-2 rounded backdrop-blur-sm border border-cyan-100 text-right shadow-sm hidden md:block">
                2. ‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏° (Data Prep)
              </div>
              <div className="absolute top-[10%] right-6 w-40 md:w-48 text-xs text-cyan-700 font-medium bg-white/80 p-2 rounded backdrop-blur-sm border border-cyan-100 text-right shadow-sm hidden md:block">
                3. ‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏≤ (Delivery)
              </div>
            </div>
            <p className="mt-4 text-center text-sm font-bold text-cyan-700">"‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?"</p>
          </div>

        </div>

        {/* Insight Box */}
        <div className="bg-slate-50 p-6 border-t border-slate-200">
          <div className="flex items-start gap-4">
            <div className="bg-yellow-100 p-2 rounded-full text-yellow-600 mt-1">
              <AlertCircle className="w-6 h-6" />
            </div>
            <div>
              <h4 className="font-bold text-lg text-slate-800 mb-2">
                {activeFlow === 'down' ? '‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≤‡∏•‡∏á (Over-dreaming)' : 
                 activeFlow === 'up' ? '‡∏à‡∏∏‡∏î‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô (Over-engineering)' : 
                 '‡∏ö‡∏ó‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£ (Executive Summary)'}
              </h4>
              <p className="text-slate-600 leading-relaxed text-sm md:text-base">
                {activeFlow === 'down' && "‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ß‡πÅ‡∏ï‡πà‡∏°‡∏≠‡∏á '‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏≠‡∏∞‡πÑ‡∏£' ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏î‡∏π‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (Lv.1-3) ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ù‡∏±‡∏ô‡πÄ‡∏ü‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (Unfeasible) ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏Å‡∏¥‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Data Pipeline ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"}
                {activeFlow === 'up' && "‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ß‡πÅ‡∏ï‡πà‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏∞‡∏≠‡∏≤‡∏î (Lv.1-3) ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (Lv.4-5) ‡∏à‡∏∞‡πÄ‡∏Å‡∏¥‡∏î '‡∏™‡∏∏‡∏™‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' (Data Swamp) ‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏°‡∏´‡∏≤‡∏®‡∏≤‡∏•‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡πÄ‡∏≠‡∏≤‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå"}
                {activeFlow === 'both' && (
                  <span>
                    ‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á <strong className="text-purple-600">‡∏Å‡∏à‡∏Ç. (PEA Data Division)</strong> ‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ <strong className="text-slate-900">Gap Analysis</strong> ‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ" ‡∏Å‡∏±‡∏ö "‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≥‡πÑ‡∏´‡∏ß"
                  </span>
                )}
              </p>
            </div>
          </div>
        </div>
      </div>

      {/* AI Modal */}
      {showAiModal && (
        <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] flex flex-col animate-in fade-in zoom-in duration-300">
            {/* Modal Header */}
            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-purple-600 to-indigo-600 rounded-t-xl text-white">
              <h3 className="font-bold text-lg flex items-center gap-2">
                {aiMode === 'scenario' ? <Lightbulb className="w-5 h-5 text-yellow-300" /> : <MessageSquare className="w-5 h-5 text-cyan-300" />}
                {aiMode === 'scenario' ? 'AI Use Case Generator' : 'AI Data Consultant'}
              </h3>
              <button onClick={() => setShowAiModal(false)} className="text-white/80 hover:text-white transition-colors">
                <X className="w-6 h-6" />
              </button>
            </div>

            {/* Modal Body */}
            <div className="p-6 overflow-y-auto flex-1 bg-slate-50">
              
              {/* Consult Mode Input */}
              {aiMode === 'consult' && !aiResponse && !isLoading && (
                <div className="space-y-4">
                  <p className="text-slate-600 text-sm">‡πÄ‡∏•‡πà‡∏≤‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ü‡∏±‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞ (‡πÄ‡∏ä‡πà‡∏ô "‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏¢‡∏≠‡∏∞‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ AI ‡πÅ‡∏ï‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©"):</p>
                  <textarea 
                    value={userQuery}
                    onChange={(e) => setUserQuery(e.target.value)}
                    className="w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 min-h-[120px]"
                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
                  />
                  <button 
                    onClick={consultAI}
                    disabled={!userQuery.trim()}
                    className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 transition-colors disabled:bg-slate-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                  >
                    <Sparkles className="w-4 h-4" /> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                  </button>
                </div>
              )}

              {/* Loading State */}
              {isLoading && (
                <div className="flex flex-col items-center justify-center py-12 text-slate-500">
                  <div className="w-12 h-12 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin mb-4"></div>
                  <p className="animate-pulse">Gemini ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</p>
                </div>
              )}

              {/* Error State */}
              {error && (
                <div className="bg-red-50 text-red-600 p-4 rounded-lg flex items-center gap-3">
                  <AlertCircle className="w-5 h-5" />
                  {error}
                </div>
              )}

              {/* Result State */}
              {aiResponse && (
                <div className="prose prose-slate max-w-none">
                  <div className="bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <pre className="whitespace-pre-wrap font-sans text-slate-700 text-sm leading-relaxed">
                      {aiResponse}
                    </pre>
                  </div>
                  {aiMode === 'consult' && (
                    <button 
                      onClick={() => { setAiResponse(''); setUserQuery(''); }}
                      className="mt-4 text-purple-600 hover:text-purple-800 text-sm font-medium underline"
                    >
                      ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ï‡πà‡∏≠
                    </button>
                  )}
                   {aiMode === 'scenario' && (
                    <button 
                      onClick={generateScenario}
                      className="mt-4 w-full py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-colors font-medium"
                    >
                      üîÑ ‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
                    </button>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default DataValueChainCanvas;
